# name: ${FILE_PATH}
# description: ${DESCRIPTION}
# group: [realnest]

name Q${QUERY_NUMBER_PADDED}
group realnest

require httpfs

require json

cache realnest.duckdb

load
attach 'https://duckdb-blobs.s3.amazonaws.com/data/realnest_benchmark_data.duckdb' as realnest_db (READ_ONLY);
CREATE TABLE single_mu_lists AS SELECT * REPLACE(list_resize(Jet, 10, NULL) as Jet, list_resize(Muon, 10, NULL) as Muon, list_resize(Photon, 10, NULL) as Photon, list_resize(Tau, 10, NULL) as Tau) 
FROM realnest_db.run2012B_singleMu;
CREATE TABLE singleMu as SELECT list_transform("Tau", x -> x.pt) AS tau_pt, list_transform("Tau", x -> x.eta) AS tau_eta,
    list_transform("Jet", x -> x.pt) AS jet_pt, list_transform("Jet", x -> x.eta) AS jet_eta, 
    list_transform("Muon", x -> x.pt) AS muon_pt, list_transform("Muon", x -> x.eta) AS muon_eta, 
    list_transform("Electron", x -> x.pt) AS el_pt, list_transform("Electron", x -> x.eta) AS el_eta, 
    list_transform("Photon", x -> x.pt) AS ph_pt, list_transform("Photon", x -> x.eta) AS ph_eta
FROM realnest_db.run2012B_singleMu; 
CREATE TABLE unnested_hlt AS (SELECT rowid, UNNEST(HLT) AS hlt FROM realnest_db.run2012B_singleMu);
CREATE TABLE unnested_pv AS (SELECT rowid, UNNEST(PV) AS pv FROM realnest_db.run2012B_singleMu);
CREATE TABLE unnested_met AS (SELECT rowid, UNNEST(MET) AS met FROM realnest_db.run2012B_singleMu);
CREATE TABLE unnested_muon AS (SELECT rowid, UNNEST(Muon, recursive:=true) AS muon FROM realnest_db.run2012B_singleMu);
CREATE TABLE unnested_electron AS (SELECT rowid, UNNEST(Electron, recursive:=true) AS electron FROM realnest_db.run2012B_singleMu);
CREATE TABLE unnested_tau AS (SELECT rowid, UNNEST(Tau, recursive:=true) AS tau FROM realnest_db.run2012B_singleMu);
CREATE TABLE unnested_photon AS (SELECT rowid, UNNEST(Photon, recursive:=true) AS photon FROM realnest_db.run2012B_singleMu);
CREATE TABLE unnested_jet AS (SELECT rowid, UNNEST(Jet, recursive:=true) AS jet FROM realnest_db.run2012B_singleMu);

run benchmark/realnest/queries/q${QUERY_NUMBER_PADDED}.sql