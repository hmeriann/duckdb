# name: test/sql/copy/encryption/simple_encryption.test
# group: [encryption]

require noforcestorage

statement ok
PRAGMA enable_verification

statement ok
ATTACH '__TEST_DIR__/unencrypted.duckdb' as unencrypted;

statement ok
ATTACH '__TEST_DIR__/v_0_10_2.duckdb' as v_0_10_2 (STORAGE_VERSION 'v0.10.2');

statement  ok
CREATE OR REPLACE TABLE unencrypted.tbl AS SELECT * FROM range(10) t(i);

statement  ok
CREATE OR REPLACE TABLE v_0_10_2.tbl AS SELECT * FROM range(10) t(i);

query I
SELECT SUM(i) FROM unencrypted.tbl
----
45

query I
SELECT SUM(i) FROM v_0_10_2.tbl
----
45

statement ok
DETACH unencrypted

statement ok
DETACH v_0_10_2

statement ok
ATTACH '__TEST_DIR__/encrypted.duckdb' AS encrypted (ENCRYPTION_KEY 'asdf');

statement ok
ATTACH '__TEST_DIR__/encrypted_v2.duckdb' AS encrypted_v2 (ENCRYPTION_KEY 'asdf');

statement ok
ATTACH '__TEST_DIR__/v_0_10_2.duckdb' as v_0_10_2;

statement ok
ATTACH '__TEST_DIR__/unencrypted.duckdb' as unencrypted;

# copy from unencrypted to encrypted
statement ok
COPY FROM DATABASE unencrypted TO encrypted;

# copy from version 0.10.2 to an encrypted db
statement ok
COPY FROM DATABASE unencrypted TO encrypted_v2;

statement ok
DETACH unencrypted

statement ok
DETACH encrypted

statement ok
DETACH encrypted_v2

statement ok
ATTACH '__TEST_DIR__/encrypted.duckdb' AS encrypted (ENCRYPTION_KEY 'asdf');

statement ok
ATTACH '__TEST_DIR__/encrypted_v2.duckdb' AS encrypted_v2 (ENCRYPTION_KEY 'asdf');

# check if we can read the encrypted data
query I
SELECT SUM(i) FROM encrypted.tbl
----
45

# check if we can read the encrypted data from the v0.10.2 db
query I
SELECT SUM(i) FROM encrypted_v2.tbl
----
45

statement ok
ATTACH '__TEST_DIR__/unencrypted_new.duckdb' as unencrypted_new;

statement ok
ATTACH '__TEST_DIR__/unencrypted_v_0_10_2.duckdb' as unencrypted_v_0_10_2 (STORAGE_VERSION 'v0.10.2');

# copy encrypted db to unencrypted database
statement ok
COPY FROM DATABASE encrypted TO unencrypted_new;

# copy encrypted db to unencrypted database with v0.10.2 storage version
statement ok
COPY FROM DATABASE encrypted TO unencrypted_v_0_10_2;

statement ok
DETACH unencrypted_new

statement ok
DETACH encrypted

statement ok
DETACH unencrypted_v_0_10_2

statement error
ATTACH '__TEST_DIR__/unencrypted_v_0_10_2.duckdb' AS unencrypted_v_0_10_2 (ENCRYPTION_KEY 'asdf');
----

statement ok
ATTACH '__TEST_DIR__/unencrypted_v_0_10_2.duckdb' AS unencrypted_v_0_10_2;

statement ok
ATTACH '__TEST_DIR__/unencrypted_new.duckdb' AS unencrypted_new;

query I
SELECT SUM(i) FROM unencrypted_v_0_10_2.tbl;
----
45

query I
SELECT SUM(i) FROM unencrypted_new.tbl;
----
45